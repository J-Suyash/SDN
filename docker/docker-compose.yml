version: '3.8'

# ML-Driven Adaptive Traffic Management in SDN
# Docker Compose Configuration - HYBRID MODE (Docker + Host Mininet)

services:
  # ============================================
  # Faucet SDN Controller
  # ============================================
  faucet:
    image: sdn-faucet:latest
    build:
      context: ./faucet
      dockerfile: Dockerfile
    container_name: sdn-faucet
    restart: unless-stopped
    volumes:
      - ../faucet:/etc/faucet:ro
      - faucet-logs:/var/log/faucet
    network_mode: host
    environment:
      - FAUCET_CONFIG=/etc/faucet/faucet.yaml
      - FAUCET_LOG=/var/log/faucet/faucet.log
      - FAUCET_EXCEPTION_LOG=/var/log/faucet/faucet_exception.log
      - FAUCET_CONFIG_STAT_RELOAD=1
      - FAUCET_EVENT_SOCK=0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9302/metrics"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # Prometheus Metrics Collection
  # ============================================
  prometheus:
    image: sdn-prometheus:latest
    build:
      context: ./prometheus
      dockerfile: Dockerfile
    container_name: sdn-prometheus
    restart: unless-stopped
    volumes:
      - prometheus-data:/prometheus
    network_mode: host
    depends_on:
      - faucet

  # ============================================
  # Grafana Dashboards
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: sdn-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    network_mode: host
    depends_on:
      - prometheus

  # ============================================
  # Faucet Gauge (Metrics Exporter)
  # ============================================
  gauge:
    image: faucet/gauge:latest
    container_name: sdn-gauge
    restart: unless-stopped
    volumes:
      - ../faucet:/etc/faucet:ro
      - faucet-logs:/var/log/faucet
    network_mode: host
    environment:
      - FAUCET_CONFIG=/etc/faucet/faucet.yaml
      - GAUGE_CONFIG=/etc/faucet/gauge.yaml
      - GAUGE_LOG=/var/log/faucet/gauge.log
      - GAUGE_EXCEPTION_LOG=/var/log/faucet/gauge_exception.log
    # Bypass faucet entrypoint script and run faucet --gauge directly
    entrypoint: []
    command: ["faucet", "--gauge", "--ryu-ofp-tcp-listen-port", "6654"]
    depends_on:
      - faucet

  # ============================================
  # ML Orchestrator
  # ============================================
  ml-orchestrator:
    image: sdn-orchestrator:latest
    build:
      context: ./ml-orchestrator
      dockerfile: Dockerfile
    container_name: sdn-orchestrator
    restart: unless-stopped
    privileged: true
    volumes:
      - ../orchestrator:/app/orchestrator
      - ../ml:/app/ml
      - ../collector:/app/collector
      - ../data:/app/data
      - /var/run/openvswitch:/var/run/openvswitch
    network_mode: host
    environment:
      - PROMETHEUS_URL=http://localhost:9090
      - FAUCET_CONFIG_PATH=/etc/faucet/faucet.yaml
      - MODEL_PATH=/app/ml/models
      - LOG_LEVEL=INFO
    depends_on:
      - prometheus
    command: ["python", "-u", "/app/orchestrator/orchestrator.py"]

volumes:
  faucet-logs:
  prometheus-data:
